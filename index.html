<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ü–µ–ª—å–º–µ—à–∫–∞ –ö–ª–∏–∫–µ—Ä | PEL STUDIO</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Nunito', sans-serif;
  overflow: hidden;
  background: #1a0a2e;
  color: #fff;
  user-select: none;
  width: 100vw;
  height: 100vh;
}

canvas#physicsCanvas {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1000;
}

/* ===== SPLASH SCREEN ===== */
#splashScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: linear-gradient(135deg, #0a0015 0%, #1a0a2e 50%, #0d0520 100%);
  z-index: 999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 1s;
}

#splashScreen .studio-title {
  font-size: 4em;
  font-weight: 900;
  background: linear-gradient(45deg, #ff6b6b, #ffa500, #ffd93d, #6bcb77, #4d96ff, #9b59b6);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: gradientShift 2s ease infinite;
  text-shadow: 0 0 30px rgba(255,107,107,0.3);
  letter-spacing: 8px;
  margin-bottom: 10px;
}

#splashScreen .studio-sub {
  font-size: 1.2em;
  color: #888;
  letter-spacing: 12px;
  text-transform: uppercase;
}

#splashBox {
  width: 300px;
  height: 300px;
  position: relative;
  margin-bottom: 40px;
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* ===== MUSIC PROMPT ===== */
#musicPrompt {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(10,0,21,0.95);
  z-index: 998;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(20px);
}

#musicPrompt h2 {
  font-size: 2.5em;
  margin-bottom: 40px;
  animation: pulse125 0.48s ease-in-out infinite alternate;
}

.prompt-btn {
  padding: 18px 50px;
  margin: 10px;
  border: none;
  border-radius: 50px;
  font-size: 1.3em;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Nunito', sans-serif;
}

.prompt-btn.yes {
  background: linear-gradient(135deg, #6bcb77, #4d96ff);
  color: #fff;
  box-shadow: 0 0 30px rgba(107,203,119,0.4);
}

.prompt-btn.no {
  background: rgba(255,255,255,0.1);
  color: #aaa;
  border: 2px solid #333;
}

.prompt-btn:hover {
  transform: scale(1.1);
}

/* ===== MAIN MENU ===== */
#mainMenu {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: linear-gradient(135deg, #0a0015, #1a0a2e, #15082b);
  z-index: 100;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#mainMenu .game-title {
  font-size: 3.5em;
  font-weight: 900;
  margin-bottom: 10px;
  text-align: center;
}

#mainMenu .game-title .pelm {
  background: linear-gradient(135deg, #ffb347, #ff6b6b);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

#mainMenu .game-subtitle {
  color: #666;
  font-size: 1.1em;
  margin-bottom: 50px;
  letter-spacing: 4px;
}

.menu-btn {
  padding: 16px 60px;
  margin: 8px;
  border: none;
  border-radius: 16px;
  font-size: 1.2em;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Nunito', sans-serif;
  position: relative;
  overflow: hidden;
  min-width: 280px;
}

.menu-btn::after {
  content: '';
  position: absolute;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%);
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { transform: translateX(-100%) rotate(45deg); }
  100% { transform: translateX(100%) rotate(45deg); }
}

.menu-btn.play {
  background: linear-gradient(135deg, #ff6b6b, #ff8e53);
  color: #fff;
  box-shadow: 0 8px 30px rgba(255,107,107,0.4);
  font-size: 1.5em;
  padding: 20px 80px;
}

.menu-btn.settings {
  background: linear-gradient(135deg, #4d96ff, #9b59b6);
  color: #fff;
  box-shadow: 0 5px 20px rgba(77,150,255,0.3);
}

.menu-btn.about {
  background: rgba(255,255,255,0.05);
  color: #666;
  border: 2px solid #333;
}

.menu-btn.love {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  color: #fff;
  box-shadow: 0 5px 20px rgba(255,107,107,0.3);
  animation: loveGlow 2s ease-in-out infinite alternate;
}

@keyframes loveGlow {
  from { box-shadow: 0 5px 20px rgba(255,107,107,0.3); }
  to { box-shadow: 0 5px 40px rgba(255,107,107,0.6), 0 0 60px rgba(238,90,36,0.2); }
}

.menu-btn:hover {
  transform: translateY(-3px) scale(1.03);
}

.menu-btn:active {
  transform: scale(0.97);
}

/* ===== SETTINGS PANEL ===== */
#settingsPanel {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(10,0,21,0.97);
  z-index: 500;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(20px);
}

.settings-content {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 20px;
  padding: 40px;
  min-width: 350px;
}

.settings-content h2 {
  text-align: center;
  margin-bottom: 30px;
  font-size: 2em;
}

.setting-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.setting-row label {
  font-size: 1.1em;
}

.toggle {
  width: 56px;
  height: 30px;
  background: #333;
  border-radius: 15px;
  cursor: pointer;
  position: relative;
  transition: background 0.3s;
}

.toggle.active {
  background: linear-gradient(135deg, #6bcb77, #4d96ff);
}

.toggle::after {
  content: '';
  position: absolute;
  width: 24px; height: 24px;
  background: #fff;
  border-radius: 50%;
  top: 3px; left: 3px;
  transition: transform 0.3s;
}

.toggle.active::after {
  transform: translateX(26px);
}

.back-btn {
  margin-top: 30px;
  padding: 12px 40px;
  background: rgba(255,255,255,0.1);
  border: none;
  border-radius: 12px;
  color: #fff;
  font-size: 1em;
  cursor: pointer;
  font-family: 'Nunito', sans-serif;
  transition: all 0.3s;
}

.back-btn:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.05);
}

/* ===== GAME SCREEN ===== */
#gameScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: linear-gradient(180deg, #0a0015, #1a0a2e);
  z-index: 50;
  display: none;
  flex-direction: column;
}

.game-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.game-stats {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.stat {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.stat-value {
  font-size: 1.4em;
  font-weight: 900;
  color: #ffb347;
}

.stat-label {
  font-size: 0.7em;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.game-header-btns {
  display: flex;
  gap: 10px;
}

.header-btn {
  padding: 8px 16px;
  background: rgba(255,255,255,0.1);
  border: none;
  border-radius: 10px;
  color: #fff;
  cursor: pointer;
  font-family: 'Nunito', sans-serif;
  font-size: 0.9em;
  transition: all 0.3s;
}

.header-btn:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.05);
}

.game-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
}

#pelmeshka {
  cursor: pointer;
  transition: transform 0.1s;
  filter: drop-shadow(0 0 30px rgba(255,179,71,0.4));
  z-index: 10;
}

#pelmeshka:active {
  transform: scale(0.92);
}

#pelmeshkaSize {
  color: #888;
  margin-top: 10px;
  font-size: 0.9em;
}

.game-bottom {
  padding: 10px 20px 20px;
  display: flex;
  gap: 10px;
  overflow-x: auto;
  background: rgba(0,0,0,0.3);
  border-top: 1px solid rgba(255,255,255,0.05);
}

.booster-btn {
  min-width: 120px;
  padding: 12px 16px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  color: #fff;
  cursor: pointer;
  font-family: 'Nunito', sans-serif;
  font-size: 0.8em;
  text-align: center;
  transition: all 0.3s;
  flex-shrink: 0;
}

.booster-btn:hover:not(:disabled) {
  background: rgba(255,255,255,0.1);
  transform: translateY(-2px);
}

.booster-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.booster-btn .booster-icon {
  font-size: 1.5em;
  display: block;
  margin-bottom: 4px;
}

.booster-btn .booster-cost {
  color: #ffb347;
  font-weight: 700;
}

.eat-btn {
  padding: 14px 40px;
  background: linear-gradient(135deg, #ff6b6b, #ff8e53);
  border: none;
  border-radius: 50px;
  color: #fff;
  font-size: 1.2em;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Nunito', sans-serif;
  margin-top: 15px;
  display: none;
  animation: eatPulse 0.5s ease-in-out infinite alternate;
  z-index: 10;
}

@keyframes eatPulse {
  from { transform: scale(1); box-shadow: 0 0 20px rgba(255,107,107,0.4); }
  to { transform: scale(1.08); box-shadow: 0 0 40px rgba(255,107,107,0.7); }
}

/* ===== ACHIEVEMENTS ===== */
#achievementsPanel {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(10,0,21,0.97);
  z-index: 500;
  display: none;
  flex-direction: column;
  align-items: center;
  backdrop-filter: blur(20px);
  overflow-y: auto;
}

.achievements-content {
  max-width: 600px;
  width: 90%;
  padding: 30px 0;
}

.achievements-content h2 {
  text-align: center;
  font-size: 2em;
  margin-bottom: 20px;
}

.ach-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
}

.ach-tab {
  padding: 8px 20px;
  background: rgba(255,255,255,0.05);
  border: none;
  border-radius: 20px;
  color: #888;
  cursor: pointer;
  font-family: 'Nunito', sans-serif;
  font-size: 0.9em;
  transition: all 0.3s;
}

.ach-tab.active {
  background: rgba(255,255,255,0.15);
  color: #fff;
}

.ach-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 15px;
  transition: all 0.3s;
}

.ach-card.unlocked {
  border-color: rgba(255,179,71,0.3);
  background: rgba(255,179,71,0.05);
}

.ach-card.rare { border-left: 3px solid #4d96ff; }
.ach-card.legendary { border-left: 3px solid #ff6b6b; animation: legendGlow 2s infinite alternate; }

@keyframes legendGlow {
  from { box-shadow: 0 0 5px rgba(255,107,107,0.1); }
  to { box-shadow: 0 0 20px rgba(255,107,107,0.2); }
}

.ach-icon {
  font-size: 2em;
  min-width: 50px;
  text-align: center;
}

.ach-info {
  flex: 1;
}

.ach-name {
  font-weight: 700;
  margin-bottom: 3px;
}

.ach-desc {
  font-size: 0.85em;
  color: #888;
}

.ach-rarity {
  font-size: 0.7em;
  padding: 3px 8px;
  border-radius: 8px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.ach-rarity.normal { background: rgba(107,203,119,0.2); color: #6bcb77; }
.ach-rarity.rare { background: rgba(77,150,255,0.2); color: #4d96ff; }
.ach-rarity.legendary { background: rgba(255,107,107,0.2); color: #ff6b6b; }

/* ===== SHOP PANEL ===== */
#shopPanel {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(10,0,21,0.97);
  z-index: 500;
  display: none;
  flex-direction: column;
  align-items: center;
  backdrop-filter: blur(20px);
  overflow-y: auto;
}

.shop-content {
  max-width: 600px;
  width: 90%;
  padding: 30px 0;
}

.shop-content h2 {
  text-align: center;
  font-size: 2em;
  margin-bottom: 20px;
}

.shop-item {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.3s;
}

.shop-item-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.shop-item-icon {
  font-size: 2em;
}

.shop-item-name {
  font-weight: 700;
}

.shop-item-desc {
  font-size: 0.8em;
  color: #888;
}

.shop-item-owned {
  font-size: 0.75em;
  color: #4d96ff;
}

.shop-buy-btn {
  padding: 8px 20px;
  background: linear-gradient(135deg, #ffb347, #ff6b6b);
  border: none;
  border-radius: 10px;
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Nunito', sans-serif;
  transition: all 0.3s;
}

.shop-buy-btn:hover:not(:disabled) { transform: scale(1.05); }
.shop-buy-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ===== PARTICLES ===== */
.click-particle {
  position: fixed;
  pointer-events: none;
  font-size: 1.5em;
  font-weight: 900;
  z-index: 200;
  animation: particleUp 1s ease-out forwards;
  color: #ffb347;
  text-shadow: 0 0 10px rgba(255,179,71,0.5);
}

@keyframes particleUp {
  0% { opacity: 1; transform: translateY(0) scale(1); }
  100% { opacity: 0; transform: translateY(-100px) scale(0.5); }
}

.emoji-particle {
  position: fixed;
  pointer-events: none;
  font-size: 2em;
  z-index: 200;
  animation: emojiFloat 2s ease-out forwards;
}

@keyframes emojiFloat {
  0% { opacity: 1; transform: translateY(0) rotate(0deg); }
  100% { opacity: 0; transform: translateY(-200px) rotate(360deg); }
}

/* ===== ACHIEVEMENT TOAST ===== */
.ach-toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: linear-gradient(135deg, rgba(255,179,71,0.95), rgba(255,107,107,0.95));
  padding: 15px 30px;
  border-radius: 16px;
  z-index: 9999;
  animation: toastIn 0.5s forwards, toastOut 0.5s 3s forwards;
  font-weight: 700;
  box-shadow: 0 10px 40px rgba(255,107,107,0.3);
}

@keyframes toastIn {
  to { transform: translateX(-50%) translateY(0); }
}

@keyframes toastOut {
  to { transform: translateX(-50%) translateY(-100px); opacity: 0; }
}

/* ===== PULSE ANIMATION ===== */
@keyframes pulse125 {
  from { transform: scale(1); }
  to { transform: scale(1.03); }
}

.pulsing {
  animation: pulse125 0.24s ease-in-out infinite alternate;
}

/* ===== FIREWORKS ===== */
.firework {
  position: fixed;
  pointer-events: none;
  z-index: 300;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  animation: fireworkAnim 1s ease-out forwards;
}

@keyframes fireworkAnim {
  0% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(0); }
}

/* ===== GOLDEN PELMESHKA EVENT ===== */
#goldenPelmeshka {
  position: fixed;
  font-size: 3em;
  cursor: pointer;
  z-index: 150;
  animation: goldenFloat 3s ease-in-out infinite alternate, goldenGlow 1s infinite alternate;
  display: none;
  filter: drop-shadow(0 0 20px gold);
}

@keyframes goldenFloat {
  0% { transform: translateY(0) rotate(-5deg); }
  100% { transform: translateY(-30px) rotate(5deg); }
}

@keyframes goldenGlow {
  from { filter: drop-shadow(0 0 20px gold) brightness(1); }
  to { filter: drop-shadow(0 0 40px gold) brightness(1.3); }
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

/* ===== PRESTIGE ===== */
.prestige-info {
  text-align: center;
  margin: 15px 0;
  padding: 15px;
  background: rgba(155,89,182,0.1);
  border: 1px solid rgba(155,89,182,0.2);
  border-radius: 12px;
}

/* ===== HEDGEHOG ===== */
.hedgehog-helper {
  position: fixed;
  bottom: 100px;
  right: 20px;
  font-size: 3em;
  z-index: 100;
  cursor: pointer;
  animation: hedgehogBounce 2s ease-in-out infinite;
  display: none;
  filter: drop-shadow(0 0 15px rgba(139,90,43,0.5));
}

@keyframes hedgehogBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px); }
}

/* ===== COMBO ===== */
.combo-indicator {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.5em;
  font-weight: 900;
  z-index: 200;
  opacity: 0;
  transition: all 0.3s;
  text-shadow: 0 0 20px currentColor;
}

.combo-indicator.show {
  opacity: 1;
}

/* ===== FEVER ===== */
.fever-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  height: 4px;
  background: linear-gradient(90deg, #ff6b6b, #ffa500, #ffd93d);
  z-index: 200;
  transition: width 0.3s;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 600px) {
  #splashScreen .studio-title { font-size: 2.5em; }
  #mainMenu .game-title { font-size: 2.2em; }
  .menu-btn { min-width: 220px; padding: 14px 30px; }
  .menu-btn.play { padding: 16px 50px; font-size: 1.2em; }
  .settings-content { min-width: auto; width: 90%; padding: 25px; }
  .game-stats { gap: 10px; }
  .stat-value { font-size: 1.1em; }
}
</style>
</head>
<body>

<!-- ===== PHYSICS SPLASH SCREEN ===== -->
<div id="splashScreen">
  <canvas id="physicsCanvas"></canvas>
  <div class="studio-title" style="z-index:1001; position:relative;">PEL STUDIO</div>
  <div class="studio-sub" style="z-index:1001; position:relative;">presents</div>
</div>

<!-- ===== MUSIC PROMPT ===== -->
<div id="musicPrompt">
  <h2>–í–∫–ª—é—á–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –º—É–∑—ã–∫—É? üéß</h2>
  <div>
    <button class="prompt-btn yes" onclick="enableMusic()">–î–∞, –¥–∞–≤–∞–π! üéµ</button>
    <button class="prompt-btn no" onclick="skipMusic()">–ù–µ—Ç, —Ç–∏—à–∏–Ω–∞ ü§´</button>
  </div>
</div>

<!-- ===== MAIN MENU ===== -->
<div id="mainMenu">
  <div class="game-title"><span class="pelm">ü•ü –ü–µ–ª—å–º–µ—à–∫–∞</span></div>
  <div class="game-title" style="font-size:2em; margin-top:-10px;"><span class="pelm">–ö–ª–∏–∫–µ—Ä</span></div>
  <div class="game-subtitle">–∫–ª–∏–∫–∞–π ‚Ä¢ —Ä–∞—Å—Ç–∏ ‚Ä¢ –µ—à—å</div>
  <button class="menu-btn play pulsable" onclick="startGame()">‚ñ∂ –ò–ì–†–ê–¢–¨</button>
  <button class="menu-btn settings pulsable" onclick="openSettings()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  <button class="menu-btn about pulsable" onclick="aboutAuthor()">üë§ –û–± –∞–≤—Ç–æ—Ä–µ</button>
  <button class="menu-btn love pulsable" onclick="lovePelmeshki()">‚ù§ –Ø –ª—é–±–ª—é –ø–µ–ª—å–º–µ—à–∫–∏!</button>
</div>

<!-- ===== SETTINGS ===== -->
<div id="settingsPanel">
  <div class="settings-content">
    <h2>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    <div class="setting-row">
      <label>üéµ –ú—É–∑—ã–∫–∞</label>
      <div class="toggle active" id="toggleMusic" onclick="toggleSetting('music')"></div>
    </div>
    <div class="setting-row">
      <label>üí´ –ü—É–ª—å—Å–∞—Ü–∏—è (125 BPM)</label>
      <div class="toggle active" id="togglePulse" onclick="toggleSetting('pulse')"></div>
    </div>
    <div class="setting-row">
      <label>‚ú® –ß–∞—Å—Ç–∏—Ü—ã</label>
      <div class="toggle active" id="toggleParticles" onclick="toggleSetting('particles')"></div>
    </div>
    <div class="setting-row">
      <label>üîä –ó–≤—É–∫–∏ –∫–ª–∏–∫–æ–≤</label>
      <div class="toggle active" id="toggleSounds" onclick="toggleSetting('sounds')"></div>
    </div>
    <div style="text-align: center;">
      <button class="back-btn" onclick="closeSettings()">‚Üê –ù–∞–∑–∞–¥</button>
      <button class="back-btn" style="background:rgba(255,50,50,0.2); margin-left:10px;" onclick="resetGame()">üóë –°–±—Ä–æ—Å</button>
    </div>
  </div>
</div>

<!-- ===== ACHIEVEMENTS ===== -->
<div id="achievementsPanel">
  <div class="achievements-content">
    <h2>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è <span id="achCount">0/25</span></h2>
    <div class="ach-tabs">
      <button class="ach-tab active" onclick="filterAch('all', this)">–í—Å–µ</button>
      <button class="ach-tab" onclick="filterAch('normal', this)">–û–±—ã—á–Ω—ã–µ</button>
      <button class="ach-tab" onclick="filterAch('rare', this)">–†–µ–¥–∫–∏–µ</button>
      <button class="ach-tab" onclick="filterAch('legendary', this)">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ</button>
    </div>
    <div id="achList"></div>
    <div style="text-align:center; margin-top:20px;">
      <button class="back-btn" onclick="closeAchievements()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  </div>
</div>

<!-- ===== SHOP ===== -->
<div id="shopPanel">
  <div class="shop-content">
    <h2>üè™ –ú–∞–≥–∞–∑–∏–Ω</h2>
    <div id="shopList"></div>
    <div class="prestige-info" id="prestigeInfo" style="display:none;">
      <div style="font-size:1.5em;">‚≠ê –ü—Ä–µ—Å—Ç–∏–∂</div>
      <div style="color:#888; margin:5px 0;">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, –Ω–æ –ø–æ–ª—É—á–∏—Ç—å –º–Ω–æ–∂–∏—Ç–µ–ª—å x<span id="prestigeMult">2</span></div>
      <button class="shop-buy-btn" id="prestigeBtn" onclick="doPrestige()">–ü—Ä–µ—Å—Ç–∏–∂! (–Ω—É–∂–Ω–æ 10000ü•ü)</button>
    </div>
    <div style="text-align:center; margin-top:20px;">
      <button class="back-btn" onclick="closeShop()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  </div>
</div>

<!-- ===== GAME SCREEN ===== -->
<div id="gameScreen">
  <div class="game-header">
    <div class="game-stats">
      <div class="stat">
        <div class="stat-value pulsable" id="scoreDisplay">0</div>
        <div class="stat-label">–ø–µ–ª—å–º–µ—à–∫–∏</div>
      </div>
      <div class="stat">
        <div class="stat-value pulsable" id="cpsDisplay">0</div>
        <div class="stat-label">–≤ —Å–µ–∫—É–Ω–¥—É</div>
      </div>
      <div class="stat">
        <div class="stat-value pulsable" id="clickPowerDisplay">1</div>
        <div class="stat-label">–∑–∞ –∫–ª–∏–∫</div>
      </div>
      <div class="stat">
        <div class="stat-value pulsable" id="sizeDisplay">1</div>
        <div class="stat-label">—Ä–∞–∑–º–µ—Ä</div>
      </div>
    </div>
    <div class="game-header-btns">
      <button class="header-btn" onclick="openShopInGame()">üè™</button>
      <button class="header-btn" onclick="openAchInGame()">üèÜ</button>
      <button class="header-btn" onclick="openSettingsInGame()">‚öô</button>
      <button class="header-btn" onclick="goToMenu()">üè†</button>
    </div>
  </div>
  
  <div class="game-main" id="gameMain">
    <div id="pelmeshkaSize">–†–∞–∑–º–µ—Ä: –º–∞–ª–µ–Ω—å–∫–∞—è ü•ü</div>
    <div id="pelmeshka" onclick="clickPelmeshka(event)">ü•ü</div>
    <button class="eat-btn" id="eatBtn" onclick="eatPelmeshka()">üç¥ –°–™–ï–°–¢–¨ –ü–ï–õ–¨–ú–ï–®–ö–£!</button>
  </div>
  
  <div class="game-bottom" id="boosterBar"></div>
</div>

<!-- ===== GOLDEN PELMESHKA ===== -->
<div id="goldenPelmeshka" onclick="clickGolden()">ü•ü</div>

<!-- ===== HEDGEHOG HELPER ===== -->
<div class="hedgehog-helper" id="hedgehogHelper" onclick="hedgehogClick()">ü¶î</div>

<!-- ===== COMBO ===== -->
<div class="combo-indicator" id="comboIndicator">COMBO x1</div>

<!-- ===== FEVER BAR ===== -->
<div class="fever-bar" id="feverBar" style="width:0%"></div>

<!-- ===== AUDIO ===== -->
<audio id="bgMusic" loop>
  <source src="musicpho.mp3" type="audio/mpeg">
</audio>

<script>
// ==========================================
// ========= GAME STATE =========
// ==========================================
let game = {
  score: 0,
  totalClicks: 0,
  totalEarned: 0,
  totalEaten: 0,
  clickPower: 1,
  cps: 0,
  pelmeshkaSize: 1,
  maxSize: 100,
  combo: 0,
  maxCombo: 0,
  lastClickTime: 0,
  fever: 0,
  feverActive: false,
  prestigeLevel: 0,
  prestigeMultiplier: 1,
  goldenClicks: 0,
  hedgehogLevel: 0,
  hedgehogActive: false,
  timePlayed: 0,
  eatenInARow: 0,
  
  // Upgrades
  upgrades: {
    fork: 0,
    doubleClick: 0,
    autoClick: 0,
    bigPelmeshka: 0,
    goldenChance: 0,
    hedgehog: 0,
    comboMaster: 0,
    feverBoost: 0,
    smetana: 0,
    microwave: 0,
    freezer: 0,
    chef: 0
  },
  
  // Settings
  settings: {
    music: true,
    pulse: true,
    particles: true,
    sounds: true
  },
  
  // Achievements
  achievements: {},
  achievementsUnlocked: 0
};

// ==========================================
// ========= ACHIEVEMENTS DATA =========
// ==========================================
const ACHIEVEMENTS = [
  // NORMAL (10) - –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
  { id: 'first_click', name: '–ü–µ—Ä–≤—ã–π —à–∞–≥', desc: '–ö–ª–∏–∫–Ω–∏ –Ω–∞ –ø–µ–ª—å–º–µ—à–∫—É –ø–µ—Ä–≤—ã–π —Ä–∞–∑', icon: 'üëÜ', rarity: 'normal' },
  { id: 'clicks_100', name: '–ö–ª–∏–∫–µ—Ä', desc: '–°–¥–µ–ª–∞–π 100 –∫–ª–∏–∫–æ–≤', icon: 'üí™', rarity: 'normal' },
  { id: 'clicks_1000', name: '–ö–ª–∏–∫–æ–º–∞–Ω', desc: '–°–¥–µ–ª–∞–π 1000 –∫–ª–∏–∫–æ–≤', icon: 'üî•', rarity: 'normal' },
  { id: 'score_100', name: '–°–æ—Ç–Ω—è', desc: '–ù–∞–±–µ—Ä–∏ 100 –ø–µ–ª—å–º–µ—à–µ–∫', icon: 'üíØ', rarity: 'normal' },
  { id: 'score_1000', name: '–¢—ã—Å—è—á–Ω–∏–∫', desc: '–ù–∞–±–µ—Ä–∏ 1000 –ø–µ–ª—å–º–µ—à–µ–∫', icon: 'üèÖ', rarity: 'normal' },
  { id: 'first_eat', name: '–í–∫—É—Å–Ω—è—Ç–∏–Ω–∞!', desc: '–°—ä–µ—à—å –ø–µ–ª—å–º–µ—à–∫—É –ø–µ—Ä–≤—ã–π —Ä–∞–∑', icon: 'üòã', rarity: 'normal' },
  { id: 'first_upgrade', name: '–ü—Ä–æ–∫–∞—á–∫–∞', desc: '–ö—É–ø–∏ –ø–µ—Ä–≤–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ', icon: '‚¨Ü', rarity: 'normal' },
  { id: 'combo_5', name: '–ö–æ–º–±–æ!', desc: '–ù–∞–±–µ—Ä–∏ –∫–æ–º–±–æ x5', icon: '‚ö°', rarity: 'normal' },
  { id: 'size_10', name: '–ü–æ–¥—Ä–æ—Å–ª–∞', desc: '–í—ã—Ä–∞—Å—Ç–∏ –ø–µ–ª—å–º–µ—à–∫—É –¥–æ —Ä–∞–∑–º–µ—Ä–∞ 10', icon: 'üìè', rarity: 'normal' },
  { id: 'play_5min', name: '–ó–∞–ª–∏–ø–∞—Ç–æ—Ä', desc: '–ò–≥—Ä–∞–π 5 –º–∏–Ω—É—Ç', icon: '‚è∞', rarity: 'normal' },
  
  // RARE (10) - –ø–æ–∫–∞–∑–∞–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ, –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ –¥–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
  { id: 'clicks_5000', name: '–ë–µ–∑—É–º–Ω—ã–π –ø–∞–ª–µ—Ü', desc: '–°–¥–µ–ª–∞–π 5000 –∫–ª–∏–∫–æ–≤', icon: 'ü§Ø', rarity: 'rare' },
  { id: 'score_10000', name: '–ü–µ–ª—å–º–µ–Ω–Ω—ã–π –±–∞—Ä–æ–Ω', desc: '–ù–∞–±–µ—Ä–∏ 10000 –ø–µ–ª—å–º–µ—à–µ–∫', icon: 'üëë', rarity: 'rare' },
  { id: 'combo_20', name: '–ö–æ–º–±–æ –º–∞—Å—Ç–µ—Ä', desc: '–ù–∞–±–µ—Ä–∏ –∫–æ–º–±–æ x20', icon: 'üí•', rarity: 'rare' },
  { id: 'golden_5', name: '–ó–æ–ª–æ—Ç–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞', desc: '–ü–æ–π–º–∞–π 5 –∑–æ–ª–æ—Ç—ã—Ö –ø–µ–ª—å–º–µ—à–µ–∫', icon: '‚ú®', rarity: 'rare' },
  { id: 'eat_10', name: '–û–±–∂–æ—Ä–∞', desc: '–°—ä–µ—à—å 10 –ø–µ–ª—å–º–µ—à–µ–∫', icon: 'üçΩ', rarity: 'rare' },
  { id: 'hedgehog_buy', name: '–Å–∂–∏–∫-–ø–æ–º–æ—â–Ω–∏–∫', desc: '–ö—É–ø–∏ —ë–∂–∏–∫–∞', icon: 'ü¶î', rarity: 'rare' },
  { id: 'fever_first', name: '–õ–ò–•–û–†–ê–î–ö–ê!', desc: '–ê–∫—Ç–∏–≤–∏—Ä—É–π fever —Ä–µ–∂–∏–º', icon: 'üå°', rarity: 'rare' },
  { id: 'size_50', name: '–ì–∏–≥–∞–Ω—Ç', desc: '–í—ã—Ä–∞—Å—Ç–∏ –ø–µ–ª—å–º–µ—à–∫—É –¥–æ —Ä–∞–∑–º–µ—Ä–∞ 50', icon: 'üèî', rarity: 'rare' },
  { id: 'upgrades_5', name: '–®–æ–ø–ø–µ—Ä', desc: '–ö—É–ø–∏ 5 —Ä–∞–∑–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π', icon: 'üõí', rarity: 'rare' },
  { id: 'prestige_first', name: '–ù–æ–≤–æ–µ –Ω–∞—á–∞–ª–æ', desc: '–°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π –ø—Ä–µ—Å—Ç–∏–∂', icon: '‚≠ê', rarity: 'rare' },
  
  // LEGENDARY (5) - –≤—Å—ë —Å–∫—Ä—ã—Ç–æ –¥–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
  { id: 'clicks_50000', name: '–õ–ï–ì–ï–ù–î–ê –ö–õ–ò–ö–û–í', desc: '–°–¥–µ–ª–∞–π 50000 –∫–ª–∏–∫–æ–≤', icon: 'üèÜ', rarity: 'legendary' },
  { id: 'score_100000', name: '–ü–ï–õ–¨–ú–ï–ù–ù–´–ô –ë–û–ì', desc: '–ù–∞–±–µ—Ä–∏ 100000 –ø–µ–ª—å–º–µ—à–µ–∫', icon: 'üëº', rarity: 'legendary' },
  { id: 'combo_50', name: '–ë–ï–°–ö–û–ù–ï–ß–ù–´–ô –ö–û–ú–ë–û', desc: '–ù–∞–±–µ—Ä–∏ –∫–æ–º–±–æ x50', icon: 'üåÄ', rarity: 'legendary' },
  { id: 'eat_100', name: '–ß–Å–†–ù–ê–Ø –î–´–†–ê', desc: '–°—ä–µ—à—å 100 –ø–µ–ª—å–º–µ—à–µ–∫', icon: 'üï≥', rarity: 'legendary' },
  { id: 'all_upgrades', name: '–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ú–û–©–¨', desc: '–ö—É–ø–∏ –≤—Å–µ —É–ª—É—á—à–µ–Ω–∏—è', icon: 'üíé', rarity: 'legendary' }
];

// ==========================================
// ========= SHOP DATA =========
// ==========================================
const SHOP_ITEMS = [
  { id: 'fork', name: '–í–∏–ª–∫–∞', desc: '+1 –∫ –∫–ª–∏–∫—É', icon: 'üç¥', baseCost: 10, costMult: 1.5, effect: 'clickPower' },
  { id: 'doubleClick', name: '–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫', desc: '–®–∞–Ω—Å x2 –∫–ª–∏–∫–∞', icon: '‚úå', baseCost: 50, costMult: 2, effect: 'doubleChance' },
  { id: 'autoClick', name: '–ê–≤—Ç–æ-–∫–ª–∏–∫', desc: '+1 –ø–µ–ª—å–º–µ—à–∫–∞/—Å–µ–∫', icon: 'ü§ñ', baseCost: 100, costMult: 1.8, effect: 'cps' },
  { id: 'bigPelmeshka', name: '–£–≤–µ–ª–∏—á–∏—Ç–µ–ª—å', desc: '–ü–µ–ª—å–º–µ—à–∫–∞ —Ä–∞—Å—Ç—ë—Ç –±—ã—Å—Ç—Ä–µ–µ', icon: 'üîç', baseCost: 75, costMult: 1.6, effect: 'growSpeed' },
  { id: 'goldenChance', name: '–ó–æ–ª–æ—Ç–æ–π —à–∞–Ω—Å', desc: '–ß–∞—â–µ –∑–æ–ª–æ—Ç—ã–µ –ø–µ–ª—å–º–µ—à–∫–∏', icon: 'üåü', baseCost: 200, costMult: 2.5, effect: 'goldenRate' },
  { id: 'hedgehog', name: '–Å–∂–∏–∫', desc: '–Å–∂–∏–∫-–ø–æ–º–æ—â–Ω–∏–∫ –∫–ª–∏–∫–∞–µ—Ç', icon: 'ü¶î', baseCost: 500, costMult: 3, effect: 'hedgehog' },
  { id: 'comboMaster', name: '–ö–æ–º–±–æ –º–∞—Å—Ç–µ—Ä', desc: '–ö–æ–º–±–æ –¥–ª–∏—Ç—Å—è –¥–æ–ª—å—à–µ', icon: '‚ö°', baseCost: 150, costMult: 2, effect: 'comboTime' },
  { id: 'feverBoost', name: 'Fever Boost', desc: 'Fever –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ', icon: 'üå°', baseCost: 300, costMult: 2.2, effect: 'feverRate' },
  { id: 'smetana', name: '–°–º–µ—Ç–∞–Ω–∫–∞', desc: '+10% –∫–æ –≤—Å–µ–º—É', icon: 'ü•õ', baseCost: 250, costMult: 2, effect: 'allBoost' },
  { id: 'microwave', name: '–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞', desc: '+5 –ø–µ–ª—å–º–µ—à–µ–∫/—Å–µ–∫', icon: 'üì°', baseCost: 1000, costMult: 2.5, effect: 'cps5' },
  { id: 'freezer', name: '–ú–æ—Ä–æ–∑–∏–ª–∫–∞', desc: '–ü–µ–ª—å–º–µ—à–∫–∏ –Ω–µ –ø–æ—Ä—Ç—è—Ç—Å—è', icon: '‚ùÑ', baseCost: 2000, costMult: 3, effect: 'preserve' },
  { id: 'chef', name: '–®–µ—Ñ-–ø–æ–≤–∞—Ä', desc: 'x2 –∫–æ –≤—Å–µ–π –ø—Ä–∏–±—ã–ª–∏', icon: 'üë®‚Äçüç≥', baseCost: 5000, costMult: 4, effect: 'doubleAll' }
];

// ==========================================
// ========= SPLASH SCREEN PHYSICS =========
// ==========================================
const canvas = document.getElementById('physicsCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let splashObjects = [];
let splashRunning = true;
let splashTimer = 0;

class PhysicsObject {
  constructor() {
    this.x = Math.random() * canvas.width;
    this.y = -50 - Math.random() * 300;
    this.vx = (Math.random() - 0.5) * 4;
    this.vy = Math.random() * 2;
    this.size = 25 + Math.random() * 25;
    this.rotation = Math.random() * Math.PI * 2;
    this.rotSpeed = (Math.random() - 0.5) * 0.1;
    this.emoji = Math.random() > 0.4 ? 'ü•ü' : 'ü¶î';
    this.bounceCount = 0;
    this.alpha = 1;
  }
  
  update() {
    this.vy += 0.3; // gravity
    this.x += this.vx;
    this.y += this.vy;
    this.rotation += this.rotSpeed;
    
    // Ground bounce
    if (this.y + this.size > canvas.height - 50) {
      this.y = canvas.height - 50 - this.size;
      this.vy *= -0.6;
      this.vx *= 0.9;
      this.bounceCount++;
      if (this.bounceCount > 3) this.vy = 0;
    }
    
    // Walls
    if (this.x < 0 || this.x + this.size > canvas.width) {
      this.vx *= -0.8;
      this.x = Math.max(0, Math.min(canvas.width - this.size, this.x));
    }
  }
  
  draw() {
    ctx.save();
    ctx.globalAlpha = this.alpha;
    ctx.translate(this.x + this.size/2, this.y + this.size/2);
    ctx.rotate(this.rotation);
    ctx.font = this.size + 'px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(this.emoji, 0, 0);
    ctx.restore();
  }
}

// Draw the "box"
function drawBox() {
  const bx = canvas.width/2 - 100;
  const by = canvas.height - 50;
  ctx.strokeStyle = 'rgba(255,255,255,0.3)';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(bx - 100, by);
  ctx.lineTo(bx + 300, by);
  ctx.stroke();
}

function splashLoop() {
  if (!splashRunning) return;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  splashTimer++;
  
  // Spawn objects
  if (splashTimer % 4 === 0 && splashObjects.length < 80) {
    splashObjects.push(new PhysicsObject());
  }
  
  drawBox();
  
  splashObjects.forEach(obj => {
    obj.update();
    obj.draw();
  });
  
  requestAnimationFrame(splashLoop);
}

// Start splash
splashLoop();

// End splash after 4 seconds
setTimeout(() => {
  splashRunning = false;
  const splash = document.getElementById('splashScreen');
  splash.style.opacity = '0';
  setTimeout(() => {
    splash.style.display = 'none';
    canvas.style.display = 'none';
    document.getElementById('musicPrompt').style.display = 'flex';
  }, 1000);
}, 4000);

// ==========================================
// ========= MUSIC =========
// ==========================================
const bgMusic = document.getElementById('bgMusic');
bgMusic.volume = 0.5;

function enableMusic() {
  game.settings.music = true;
  bgMusic.play().catch(() => {});
  document.getElementById('musicPrompt').style.display = 'none';
  showMainMenu();
}

function skipMusic() {
  game.settings.music = false;
  document.getElementById('toggleMusic').classList.remove('active');
  document.getElementById('musicPrompt').style.display = 'none';
  showMainMenu();
}

// ==========================================
// ========= PULSE SYSTEM (125 BPM) =========
// ==========================================
// 125 BPM = 125 beats per minute = beat every 480ms
const BEAT_INTERVAL = 480; // ms
let beatActive = true;

function startPulse() {
  setInterval(() => {
    if (!game.settings.pulse) return;
    document.querySelectorAll('.pulsable').forEach(el => {
      el.style.transform = 'scale(1.05)';
      setTimeout(() => {
        el.style.transform = 'scale(1)';
      }, BEAT_INTERVAL / 2);
    });
    
    // Pelmeshka pulse
    const pelm = document.getElementById('pelmeshka');
    if (pelm && document.getElementById('gameScreen').style.display !== 'none') {
      const currentSize = getPelmeshkaFontSize();
      pelm.style.fontSize = (currentSize * 1.03) + 'px';
      setTimeout(() => {
        pelm.style.fontSize = currentSize + 'px';
      }, BEAT_INTERVAL / 2);
    }
  }, BEAT_INTERVAL);
}

startPulse();

// ==========================================
// ========= NAVIGATION =========
// ==========================================
function showMainMenu() {
  document.getElementById('mainMenu').style.display = 'flex';
  animateMenuButtons();
}

function animateMenuButtons() {
  const buttons = document.querySelectorAll('.menu-btn');
  buttons.forEach((btn, i) => {
    btn.style.opacity = '0';
    btn.style.transform = 'translateY(30px)';
    setTimeout(() => {
      btn.style.transition = 'all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
      btn.style.opacity = '1';
      btn.style.transform = 'translateY(0)';
    }, 200 + i * 100);
  });
}

function startGame() {
  document.getElementById('mainMenu').style.display = 'none';
  document.getElementById('gameScreen').style.display = 'flex';
  initGame();
}

function goToMenu() {
  document.getElementById('gameScreen').style.display = 'none';
  document.getElementById('mainMenu').style.display = 'flex';
  saveGame();
}

let settingsFrom = 'menu';

function openSettings() {
  settingsFrom = 'menu';
  document.getElementById('settingsPanel').style.display = 'flex';
  updateSettingsUI();
}

function openSettingsInGame() {
  settingsFrom = 'game';
  document.getElementById('settingsPanel').style.display = 'flex';
  updateSettingsUI();
}

function closeSettings() {
  document.getElementById('settingsPanel').style.display = 'none';
}

function openAchInGame() {
  achievementsFrom = 'game';
  openAchievements();
}

let achievementsFrom = 'menu';

function openAchievements() {
  document.getElementById('achievementsPanel').style.display = 'flex';
  renderAchievements();
}

function closeAchievements() {
  document.getElementById('achievementsPanel').style.display = 'none';
}

function openShopInGame() {
  document.getElementById('shopPanel').style.display = 'flex';
  renderShop();
}

function closeShop() {
  document.getElementById('shopPanel').style.display = 'none';
}

function aboutAuthor() {
  // Does nothing as specified
  const btn = event.target;
  btn.style.transform = 'scale(0.95) rotate(2deg)';
  setTimeout(() => btn.style.transform = '', 300);
}

function lovePelmeshki() {
  // Activate achievements and show confetti
  createFireworks(window.innerWidth/2, window.innerHeight/2, 30);
  showToast('‚ù§ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã! –ö–ª–∏–∫–∞–π –∏ —Ä–∞—Å—Ç–∏! ‚ù§');
  
  // Open achievements
  setTimeout(() => {
    achievementsFrom = 'menu';
    openAchievements();
  }, 1000);
}

// ==========================================
// ========= SETTINGS =========
// ==========================================
function toggleSetting(setting) {
  game.settings[setting] = !game.settings[setting];
  updateSettingsUI();
  
  if (setting === 'music') {
    if (game.settings.music) {
      bgMusic.play().catch(() => {});
    } else {
      bgMusic.pause();
    }
  }
  
  saveGame();
}

function updateSettingsUI() {
  document.getElementById('toggleMusic').classList.toggle('active', game.settings.music);
  document.getElementById('togglePulse').classList.toggle('active', game.settings.pulse);
  document.getElementById('toggleParticles').classList.toggle('active', game.settings.particles);
  document.getElementById('toggleSounds').classList.toggle('active', game.settings.sounds);
}

// ==========================================
// ========= GAME LOGIC =========
// ==========================================
function initGame() {
  loadGame();
  updateDisplays();
  renderBoosterBar();
  startAutoClicker();
  startGoldenPelmeshka();
  startTimePlayed();
  
  if (game.upgrades.hedgehog > 0) {
    document.getElementById('hedgehogHelper').style.display = 'block';
    game.hedgehogActive = true;
  }
  
  updatePelmeshkaVisual();
}

function getPelmeshkaFontSize() {
  const baseSize = 80;
  return baseSize + game.pelmeshkaSize * 2;
}

function updatePelmeshkaVisual() {
  const pelm = document.getElementById('pelmeshka');
  const fontSize = getPelmeshkaFontSize();
  pelm.style.fontSize = fontSize + 'px';
  
  // Size description
  const sizeEl = document.getElementById('pelmeshkaSize');
  let sizeText = '';
  if (game.pelmeshkaSize < 10) sizeText = '–º–∞–ª–µ–Ω—å–∫–∞—è ü•ü';
  else if (game.pelmeshkaSize < 25) sizeText = '—Å—Ä–µ–¥–Ω—è—è ü•üü•ü';
  else if (game.pelmeshkaSize < 50) sizeText = '–±–æ–ª—å—à–∞—è ü•üü•üü•ü';
  else if (game.pelmeshkaSize < 75) sizeText = '–û–ì–†–û–ú–ù–ê–Ø ü•üü•üü•üü•ü';
  else sizeText = '–ì–ò–ì–ê–ù–¢–°–ö–ê–Ø!!! ü•üü•üü•üü•üü•ü';
  sizeEl.textContent = `–†–∞–∑–º–µ—Ä: ${sizeText} (${Math.floor(game.pelmeshkaSize)}/${game.maxSize})`;
  
  // Show eat button when big enough
  const eatBtn = document.getElementById('eatBtn');
  if (game.pelmeshkaSize >= 30) {
    eatBtn.style.display = 'block';
  } else {
    eatBtn.style.display = 'none';
  }
}

function clickPelmeshka(event) {
  const now = Date.now();
  
  // Calculate click power
  let power = game.clickPower;
  
  // Double click chance
  if (game.upgrades.doubleClick > 0 && Math.random() < game.upgrades.doubleClick * 0.1) {
    power *= 2;
  }
  
  // Fever bonus
  if (game.feverActive) {
    power *= 5;
  }
  
  // Combo
  if (now - game.lastClickTime < (1000 + game.upgrades.comboMaster * 500)) {
    game.combo++;
    if (game.combo > game.maxCombo) game.maxCombo = game.combo;
    power += Math.floor(game.combo / 5);
  } else {
    game.combo = 0;
  }
  game.lastClickTime = now;
  
  // Smetana boost
  if (game.upgrades.smetana > 0) {
    power = Math.floor(power * (1 + game.upgrades.smetana * 0.1));
  }
  
  // Chef double all
  if (game.upgrades.chef > 0) {
    power *= (1 + game.upgrades.chef);
  }
  
  // Prestige multiplier
  power = Math.floor(power * game.prestigeMultiplier);
  
  // Add score
  game.score += power;
  game.totalClicks++;
  game.totalEarned += power;
  
  // Grow pelmeshka
  let growAmount = 0.1 + game.upgrades.bigPelmeshka * 0.05;
  game.pelmeshkaSize = Math.min(game.maxSize, game.pelmeshkaSize + growAmount);
  
  // Fever meter
  game.fever = Math.min(100, game.fever + (1 + game.upgrades.feverBoost * 0.5));
  updateFeverBar();
  if (game.fever >= 100 && !game.feverActive) {
    activateFever();
  }
  
  // Particles
  if (game.settings.particles) {
    createClickParticle(event.clientX, event.clientY, '+' + power);
    if (Math.random() > 0.7) {
      createEmojiParticle(event.clientX, event.clientY);
    }
  }
  
  // Click sound
  if (game.settings.sounds) {
    playClickSound();
  }
  
  // Update combo indicator
  updateComboIndicator();
  
  // Update displays
  updateDisplays();
  updatePelmeshkaVisual();
  
  // Check achievements
  checkAchievements();
  
  // Click animation
  const pelm = document.getElementById('pelmeshka');
  pelm.style.transform = 'scale(0.9)';
  setTimeout(() => pelm.style.transform = 'scale(1)', 100);
}

function eatPelmeshka() {
  if (game.pelmeshkaSize < 30) return;
  
  const bonus = Math.floor(game.pelmeshkaSize * 10 * game.prestigeMultiplier);
  game.score += bonus;
  game.totalEarned += bonus;
  game.totalEaten++;
  game.pelmeshkaSize = 1;
  game.eatenInARow++;
  
  // Effects
  if (game.settings.particles) {
    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        createEmojiParticle(
          window.innerWidth/2 + (Math.random()-0.5)*200,
          window.innerHeight/2 + (Math.random()-0.5)*200
        );
      }, i * 50);
    }
    createFireworks(window.innerWidth/2, window.innerHeight/2, 20);
  }
  
  showToast(`üòã –ü–ï–õ–¨–ú–ï–®–ö–ê –°–™–ï–î–ï–ù–ê! +${bonus} ü•ü`);
  
  updateDisplays();
  updatePelmeshkaVisual();
  checkAchievements();
}

// ==========================================
// ========= AUTO CLICKER & CPS =========
// ==========================================
let autoClickerInterval;

function startAutoClicker() {
  if (autoClickerInterval) clearInterval(autoClickerInterval);
  
  autoClickerInterval = setInterval(() => {
    let cps = game.upgrades.autoClick;
    
    // Microwave
    cps += game.upgrades.microwave * 5;
    
    // Hedgehog
    cps += game.upgrades.hedgehog * 2;
    
    // Smetana boost
    if (game.upgrades.smetana > 0) {
      cps = Math.floor(cps * (1 + game.upgrades.smetana * 0.1));
    }
    
    // Chef
    if (game.upgrades.chef > 0) {
      cps *= (1 + game.upgrades.chef);
    }
    
    // Prestige
    cps = Math.floor(cps * game.prestigeMultiplier);
    
    if (cps > 0) {
      game.score += cps;
      game.totalEarned += cps;
      game.cps = cps;
      
      // Grow pelmeshka passively
      game.pelmeshkaSize = Math.min(game.maxSize, game.pelmeshkaSize + 0.01 * cps);
      
      updateDisplays();
      updatePelmeshkaVisual();
      checkAchievements();
    }
  }, 1000);
}

// ==========================================
// ========= COMBO SYSTEM =========
// ==========================================
function updateComboIndicator() {
  const indicator = document.getElementById('comboIndicator');
  if (game.combo > 2) {
    indicator.textContent = `COMBO x${game.combo}`;
    indicator.classList.add('show');
    
    // Color based on combo
    if (game.combo >= 30) indicator.style.color = '#ff6b6b';
    else if (game.combo >= 15) indicator.style.color = '#ffa500';
    else if (game.combo >= 5) indicator.style.color = '#ffd93d';
    else indicator.style.color = '#6bcb77';
    
    indicator.style.fontSize = Math.min(3, 1.5 + game.combo * 0.05) + 'em';
  } else {
    indicator.classList.remove('show');
  }
}

// ==========================================
// ========= FEVER SYSTEM =========
// ==========================================
function updateFeverBar() {
  document.getElementById('feverBar').style.width = game.fever + '%';
}

function activateFever() {
  game.feverActive = true;
  game.fever = 100;
  checkAchievement('fever_first');
  
  showToast('üî• FEVER MODE! x5 –∫–æ –≤—Å–µ–º—É –Ω–∞ 10 —Å–µ–∫—É–Ω–¥! üî•');
  
  document.body.style.background = '#2a0a0a';
  document.getElementById('feverBar').style.background = 'linear-gradient(90deg, #ff0000, #ff6600, #ffff00)';
  
  const feverDuration = 10000;
  const startTime = Date.now();
  
  const feverInterval = setInterval(() => {
    const elapsed = Date.now() - startTime;
    game.fever = Math.max(0, 100 - (elapsed / feverDuration * 100));
    updateFeverBar();
    
    if (elapsed >= feverDuration) {
      clearInterval(feverInterval);
      game.feverActive = false;
      game.fever = 0;
      updateFeverBar();
      document.body.style.background = '';
      document.getElementById('feverBar').style.background = '';
    }
  }, 100);
}

// ==========================================
// ========= GOLDEN PELMESHKA =========
// ==========================================
let goldenInterval;

function startGoldenPelmeshka() {
  if (goldenInterval) clearInterval(goldenInterval);
  
  goldenInterval = setInterval(() => {
    const baseChance = 0.05;
    const bonusChance = game.upgrades.goldenChance * 0.03;
    
    if (Math.random() < baseChance + bonusChance) {
      spawnGolden();
    }
  }, 5000);
}

function spawnGolden() {
  const golden = document.getElementById('goldenPelmeshka');
  golden.style.display = 'block';
  golden.style.left = (Math.random() * (window.innerWidth - 80)) + 'px';
  golden.style.top = (Math.random() * (window.innerHeight - 200) + 100) + 'px';
  
  setTimeout(() => {
    golden.style.display = 'none';
  }, 5000);
}

function clickGolden() {
  const golden = document.getElementById('goldenPelmeshka');
  golden.style.display = 'none';
  
  const bonus = Math.floor((100 + game.totalEarned * 0.1) * game.prestigeMultiplier);
  game.score += bonus;
  game.totalEarned += bonus;
  game.goldenClicks++;
  
  createFireworks(
    parseInt(golden.style.left) + 40,
    parseInt(golden.style.top) + 40,
    15
  );
  
  showToast(`‚ú® –ó–æ–ª–æ—Ç–∞—è –ø–µ–ª—å–º–µ—à–∫–∞! +${bonus} ü•ü`);
  
  updateDisplays();
  checkAchievements();
}

// ==========================================
// ========= HEDGEHOG =========
// ==========================================
function hedgehogClick() {
  const hedgehog = document.getElementById('hedgehogHelper');
  hedgehog.style.transform = 'scale(1.3)';
  setTimeout(() => hedgehog.style.transform = '', 300);
  
  const bonus = Math.floor(game.upgrades.hedgehog * 5 * game.prestigeMultiplier);
  game.score += bonus;
  game.totalEarned += bonus;
  
  if (game.settings.particles) {
    createClickParticle(
      hedgehog.getBoundingClientRect().left + 30,
      hedgehog.getBoundingClientRect().top,
      '+' + bonus + 'ü¶î'
    );
  }
  
  updateDisplays();
}

// ==========================================
// ========= PRESTIGE =========
// ==========================================
function doPrestige() {
  if (game.totalEarned < 10000) {
    showToast('‚ùå –ù—É–∂–Ω–æ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –º–∏–Ω–∏–º—É–º 10000 –ø–µ–ª—å–º–µ—à–µ–∫!');
    return;
  }
  
  game.prestigeLevel++;
  game.prestigeMultiplier = 1 + game.prestigeLevel * 0.5;
  
  // Reset
  game.score = 0;
  game.pelmeshkaSize = 1;
  game.combo = 0;
  game.fever = 0;
  game.feverActive = false;
  
  Object.keys(game.upgrades).forEach(k => game.upgrades[k] = 0);
  
  document.getElementById('hedgehogHelper').style.display = 'none';
  game.hedgehogActive = false;
  
  showToast(`‚≠ê –ü–†–ï–°–¢–ò–ñ ${game.prestigeLevel}! –ú–Ω–æ–∂–∏—Ç–µ–ª—å x${game.prestigeMultiplier}!`);
  createFireworks(window.innerWidth/2, window.innerHeight/2, 40);
  
  checkAchievement('prestige_first');
  
  updateDisplays();
  updatePelmeshkaVisual();
  renderBoosterBar();
  renderShop();
  startAutoClicker();
  saveGame();
}

// ==========================================
// ========= SHOP RENDERING =========
// ==========================================
function renderShop() {
  const list = document.getElementById('shopList');
  list.innerHTML = '';
  
  SHOP_ITEMS.forEach(item => {
    const cost = Math.floor(item.baseCost * Math.pow(item.costMult, game.upgrades[item.id]));
    const owned = game.upgrades[item.id];
    const canBuy = game.score >= cost;
    
    const div = document.createElement('div');
    div.className = 'shop-item';
    div.innerHTML = `
      <div class="shop-item-info">
        <div class="shop-item-icon">${item.icon}</div>
        <div>
          <div class="shop-item-name">${item.name}</div>
          <div class="shop-item-desc">${item.desc}</div>
          <div class="shop-item-owned">–ö—É–ø–ª–µ–Ω–æ: ${owned}</div>
        </div>
      </div>
      <button class="shop-buy-btn" onclick="buyUpgrade('${item.id}')" ${canBuy ? '' : 'disabled'}>
        ${cost} ü•ü
      </button>
    `;
    list.appendChild(div);
  });
  
  // Prestige section
  const prestigeInfo = document.getElementById('prestigeInfo');
  if (game.totalEarned >= 5000) {
    prestigeInfo.style.display = 'block';
    document.getElementById('prestigeMult').textContent = (1 + (game.prestigeLevel + 1) * 0.5).toFixed(1);
    document.getElementById('prestigeBtn').disabled = game.totalEarned < 10000;
  }
}

function buyUpgrade(id) {
  const item = SHOP_ITEMS.find(i => i.id === id);
  const cost = Math.floor(item.baseCost * Math.pow(item.costMult, game.upgrades[id]));
  
  if (game.score < cost) return;
  
  game.score -= cost;
  game.upgrades[id]++;
  
  // Apply effects
  game.clickPower = 1 + game.upgrades.fork;
  
  // Hedgehog activation
  if (id === 'hedgehog' && game.upgrades.hedgehog === 1) {
    document.getElementById('hedgehogHelper').style.display = 'block';
    game.hedgehogActive = true;
    checkAchievement('hedgehog_buy');
  }
  
  checkAchievement('first_upgrade');
  
  // Check upgrades_5
  const uniqueUpgrades = Object.values(game.upgrades).filter(v => v > 0).length;
  if (uniqueUpgrades >= 5) checkAchievement('upgrades_5');
  
  // Check all_upgrades
  const allBought = Object.values(game.upgrades).every(v => v > 0);
  if (allBought) checkAchievement('all_upgrades');
  
  startAutoClicker();
  updateDisplays();
  renderShop();
  renderBoosterBar();
  
  if (game.settings.particles) {
    createFireworks(window.innerWidth/2, window.innerHeight/3, 10);
  }
  
  saveGame();
}

// ==========================================
// ========= BOOSTER BAR =========
// ==========================================
function renderBoosterBar() {
  const bar = document.getElementById('boosterBar');
  bar.innerHTML = '';
  
  const quickBuy = SHOP_ITEMS.slice(0, 6);
  quickBuy.forEach(item => {
    const cost = Math.floor(item.baseCost * Math.pow(item.costMult, game.upgrades[item.id]));
    const canBuy = game.score >= cost;
    
    const btn = document.createElement('button');
    btn.className = 'booster-btn';
    btn.disabled = !canBuy;
    btn.innerHTML = `
      <span class="booster-icon">${item.icon}</span>
      <div>${item.name} (${game.upgrades[item.id]})</div>
      <div class="booster-cost">${cost} ü•ü</div>
    `;
    btn.onclick = () => buyUpgrade(item.id);
    bar.appendChild(btn);
  });
}

// ==========================================
// ========= ACHIEVEMENTS SYSTEM =========
// ==========================================
function checkAchievement(id) {
  if (game.achievements[id]) return;
  game.achievements[id] = true;
  game.achievementsUnlocked++;
  
  const ach = ACHIEVEMENTS.find(a => a.id === id);
  
  let name = ach.name;
  showToast(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${name}! ${ach.icon}`);
  createFireworks(window.innerWidth/2, 50, 15);
  
  saveGame();
}

function checkAchievements() {
  if (game.totalClicks >= 1) checkAchievement('first_click');
  if (game.totalClicks >= 100) checkAchievement('clicks_100');
  if (game.totalClicks >= 1000) checkAchievement('clicks_1000');
  if (game.totalClicks >= 5000) checkAchievement('clicks_5000');
  if (game.totalClicks >= 50000) checkAchievement('clicks_50000');
  
  if (game.totalEarned >= 100) checkAchievement('score_100');
  if (game.totalEarned >= 1000) checkAchievement('score_1000');
  if (game.totalEarned >= 10000) checkAchievement('score_10000');
  if (game.totalEarned >= 100000) checkAchievement('score_100000');
  
  if (game.totalEaten >= 1) checkAchievement('first_eat');
  if (game.totalEaten >= 10) checkAchievement('eat_10');
  if (game.totalEaten >= 100) checkAchievement('eat_100');
  
  if (game.maxCombo >= 5) checkAchievement('combo_5');
  if (game.maxCombo >= 20) checkAchievement('combo_20');
  if (game.maxCombo >= 50) checkAchievement('combo_50');
  
  if (game.goldenClicks >= 5) checkAchievement('golden_5');
  
  if (game.pelmeshkaSize >= 10) checkAchievement('size_10');
  if (game.pelmeshkaSize >= 50) checkAchievement('size_50');
  
  if (game.timePlayed >= 300) checkAchievement('play_5min');
}

function renderAchievements(filter = 'all') {
  const list = document.getElementById('achList');
  list.innerHTML = '';
  
  let count = Object.keys(game.achievements).length;
  document.getElementById('achCount').textContent = `${count}/${ACHIEVEMENTS.length}`;
  
  ACHIEVEMENTS.forEach(ach => {
    if (filter !== 'all' && ach.rarity !== filter) return;
    
    const unlocked = game.achievements[ach.id];
    const card = document.createElement('div');
    card.className = `ach-card ${ach.rarity} ${unlocked ? 'unlocked' : ''}`;
    
    let name, desc, icon;
    
    if (ach.rarity === 'normal') {
      // Normal: always show name and desc
      name = ach.name;
      desc = ach.desc;
      icon = unlocked ? ach.icon : 'üîí';
    } else if (ach.rarity === 'rare') {
      // Rare: show desc always, name hidden until unlocked
      name = unlocked ? ach.name : '‚ùì‚ùì‚ùì';
      desc = ach.desc;
      icon = unlocked ? ach.icon : 'üîí';
    } else {
      // Legendary: everything hidden until unlocked
      name = unlocked ? ach.name : '‚ùì‚ùì‚ùì';
      desc = unlocked ? ach.desc : '‚ùì‚ùì‚ùì‚ùì‚ùì‚ùì‚ùì‚ùì';
      icon = unlocked ? ach.icon : '‚ùì';
    }
    
    const rarityLabels = { normal: '–û–±—ã—á–Ω–æ–µ', rare: '–†–µ–¥–∫–æ–µ', legendary: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ' };
    
    card.innerHTML = `
      <div class="ach-icon">${icon}</div>
      <div class="ach-info">
        <div class="ach-name">${name}</div>
        <div class="ach-desc">${desc}</div>
      </div>
      <div class="ach-rarity ${ach.rarity}">${rarityLabels[ach.rarity]}</div>
    `;
    
    list.appendChild(card);
  });
}

function filterAch(filter, btn) {
  document.querySelectorAll('.ach-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderAchievements(filter);
}

// ==========================================
// ========= DISPLAY UPDATES =========
// ==========================================
function updateDisplays() {
  document.getElementById('scoreDisplay').textContent = formatNumber(Math.floor(game.score));
  
  let cps = game.upgrades.autoClick + game.upgrades.microwave * 5 + game.upgrades.hedgehog * 2;
  if (game.upgrades.smetana > 0) cps = Math.floor(cps * (1 + game.upgrades.smetana * 0.1));
  if (game.upgrades.chef > 0) cps *= (1 + game.upgrades.chef);
  cps = Math.floor(cps * game.prestigeMultiplier);
  game.cps = cps;
  
  document.getElementById('cpsDisplay').textContent = formatNumber(cps);
  document.getElementById('clickPowerDisplay').textContent = formatNumber(game.clickPower);
  document.getElementById('sizeDisplay').textContent = Math.floor(game.pelmeshkaSize);
  
  // Update booster bar affordability
  renderBoosterBar();
}

function formatNumber(n) {
  if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n/1000).toFixed(1) + 'K';
  return Math.floor(n).toString();
}

// ==========================================
// ========= PARTICLES & EFFECTS =========
// ==========================================
function createClickParticle(x, y, text) {
  const particle = document.createElement('div');
  particle.className = 'click-particle';
  particle.textContent = text;
  particle.style.left = (x + (Math.random()-0.5)*40) + 'px';
  particle.style.top = y + 'px';
  document.body.appendChild(particle);
  setTimeout(() => particle.remove(), 1000);
}

function createEmojiParticle(x, y) {
  const emojis = ['ü•ü', 'ü¶î', '‚≠ê', '‚ù§', 'üî•', '‚ú®', 'üí´', 'üç¥', 'üòã', 'ü•õ'];
  const particle = document.createElement('div');
  particle.className = 'emoji-particle';
  particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
  particle.style.left = (x + (Math.random()-0.5)*100) + 'px';
  particle.style.top = y + 'px';
  document.body.appendChild(particle);
  setTimeout(() => particle.remove(), 2000);
}

function createFireworks(x, y, count) {
  const colors = ['#ff6b6b','#ffa500','#ffd93d','#6bcb77','#4d96ff','#9b59b6','#ff69b4'];
  for (let i = 0; i < count; i++) {
    const fw = document.createElement('div');
    fw.className = 'firework';
    const angle = (Math.PI * 2 / count) * i;
    const dist = 50 + Math.random() * 100;
    const dx = Math.cos(angle) * dist;
    const dy = Math.sin(angle) * dist;
    fw.style.left = x + 'px';
    fw.style.top = y + 'px';
    fw.style.background = colors[Math.floor(Math.random() * colors.length)];
    fw.style.transition = 'all 1s ease-out';
    document.body.appendChild(fw);
    requestAnimationFrame(() => {
      fw.style.left = (x + dx) + 'px';
      fw.style.top = (y + dy) + 'px';
      fw.style.opacity = '0';
    });
    setTimeout(() => fw.remove(), 1000);
  }
}

// ==========================================
// ========= TOAST NOTIFICATIONS =========
// ==========================================
function showToast(text) {
  const toast = document.createElement('div');
  toast.className = 'ach-toast';
  toast.textContent = text;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// ==========================================
// ========= SOUNDS =========
// ==========================================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;

function playClickSound() {
  if (!audioCtx) audioCtx = new AudioCtx();
  
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  
  osc.frequency.setValueAtTime(800 + Math.random() * 400, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
  
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.1);
}

// ==========================================
// ========= TIME TRACKING =========
// ==========================================
let timeInterval;

function startTimePlayed() {
  if (timeInterval) clearInterval(timeInterval);
  timeInterval = setInterval(() => {
    game.timePlayed++;
    checkAchievements();
  }, 1000);
}

// ==========================================
// ========= SAVE / LOAD =========
// ==========================================
function saveGame() {
  try {
    localStorage.setItem('pelmeshka_save', JSON.stringify(game));
  } catch(e) {}
}

function loadGame() {
  try {
    const save = localStorage.getItem('pelmeshka_save');
    if (save) {
      const loaded = JSON.parse(save);
      // Merge carefully
      Object.keys(loaded).forEach(key => {
        if (typeof loaded[key] === 'object' && !Array.isArray(loaded[key]) && game[key]) {
          Object.assign(game[key], loaded[key]);
        } else {
          game[key] = loaded[key];
        }
      });
      game.clickPower = 1 + game.upgrades.fork;
    }
  } catch(e) {}
}

function resetGame() {
  if (confirm('–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–Å? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
    localStorage.removeItem('pelmeshka_save');
    location.reload();
  }
}

// Auto-save every 30 seconds
setInterval(saveGame, 30000);

// Save on tab close
window.addEventListener('beforeunload', saveGame);

// ==========================================
// ========= RESIZE =========
// ==========================================
window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

// ==========================================
// ========= BACKGROUND ANIMATION =========
// ==========================================
function createBgParticle() {
  if (document.getElementById('gameScreen').style.display === 'none') return;
  if (!game.settings.particles) return;
  
  const particle = document.createElement('div');
  particle.className = 'emoji-particle';
  particle.textContent = Math.random() > 0.5 ? 'ü•ü' : 'ü¶î';
  particle.style.left = Math.random() * window.innerWidth + 'px';
  particle.style.top = window.innerHeight + 'px';
  particle.style.opacity = '0.2';
  particle.style.fontSize = '1em';
  document.getElementById('gameMain').appendChild(particle);
  setTimeout(() => particle.remove(), 2000);
}

setInterval(createBgParticle, 2000);

// ==========================================
// ========= HEDGEHOG AUTO CLICK =========
// ==========================================
setInterval(() => {
  if (game.hedgehogActive && game.upgrades.hedgehog > 0) {
    const hedgehog = document.getElementById('hedgehogHelper');
    if (hedgehog.style.display !== 'none') {
      hedgehog.style.transform = 'scale(1.15) rotate(5deg)';
      setTimeout(() => hedgehog.style.transform = '', 200);
      
      const bonus = Math.floor(game.upgrades.hedgehog * game.prestigeMultiplier);
      game.score += bonus;
      game.totalEarned += bonus;
      game.pelmeshkaSize = Math.min(game.maxSize, game.pelmeshkaSize + 0.005 * game.upgrades.hedgehog);
      
      updateDisplays();
      updatePelmeshkaVisual();
    }
  }
}, 2000);

// ==========================================
// ========= KEYBOARD SHORTCUTS =========
// ==========================================
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space' && document.getElementById('gameScreen').style.display !== 'none') {
    e.preventDefault();
    clickPelmeshka({ clientX: window.innerWidth/2, clientY: window.innerHeight/2 });
  }
  if (e.code === 'Escape') {
    closeSettings();
    closeAchievements();
    closeShop();
  }
});

// ==========================================
// ========= KONAMI CODE (easter egg) =========
// ==========================================
let konamiSequence = [];
const KONAMI = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','KeyB','KeyA'];

document.addEventListener('keydown', (e) => {
  konamiSequence.push(e.code);
  if (konamiSequence.length > KONAMI.length) konamiSequence.shift();
  if (konamiSequence.join(',') === KONAMI.join(',')) {
    game.score += 99999;
    game.totalEarned += 99999;
    showToast('üéÆ KONAMI CODE! +99999 ü•ü!!!');
    createFireworks(window.innerWidth/2, window.innerHeight/2, 50);
    updateDisplays();
    konamiSequence = [];
  }
});

console.log('%cü•ü PEL STUDIO ü•ü', 'font-size:30px; color:#ffb347; font-weight:bold;');
console.log('%c–ü–µ–ª—å–º–µ—à–∫–∞ –ö–ª–∏–∫–µ—Ä v1.0', 'font-size:14px; color:#888;');
</script>
</body>
    </html>
